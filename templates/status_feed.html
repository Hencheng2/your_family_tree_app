{% extends 'base.html' %}

{% block title %}Status Feed{% endblock %}

{% block content %}
<style>
    /* Ensure HTML and Body take full height and manage overflow */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Crucial: Prevents main body scroll */
    }

    body {
        display: flex; /* Use flexbox for main body layout */
        flex-direction: column; /* Stack children vertically */
        min-height: 100vh; /* Ensure body takes full viewport height */
        background-color: var(--background-color); /* Match background */
        color: var(--text-color); /* Match text color */
    }

    /* Fixed Top Title Container */
    .fixed-top-title-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: var(--background-color); /* Match page background */
        color: var(--text-color);
        padding: 15px 20px;
        box-shadow: none; /* No shadow */
        border: none; /* No border */
        z-index: 1000; /* Ensure it's above scrollable content */
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding-top: 70px; /* Space for main navbar */
        padding-bottom: 15px; /* Padding below content */
        border-bottom: 1px solid var(--card-border); /* Separator */
        box-sizing: border-box; /* Include padding in width/height */
    }

    .fixed-top-title-container h1 {
        margin-bottom: 0; /* No extra margin below title */
        font-size: 1.8em; /* Default font size */
    }

    /* Scrollable Content Container */
    .scrollable-content-container {
        position: fixed; /* Make it fixed */
        left: 0;
        right: 0;
        width: 100%; /* Ensure it spans full width */
        background-color: transparent; /* No background for this container */
        border: none; /* No border */
        box-shadow: none; /* No shadow */
        overflow-y: auto; /* THIS MAKES IT SCROLLABLE */
        box-sizing: border-box;
        padding: 20px; /* Padding inside the scrollable area */
        /* top and bottom will be set by JS */
    }

    /* Status Feed Specific Styles (now inside the scrollable container) */
    .status-feed-inner-content {
        max-width: 600px;
        margin: 0 auto; /* Center content within the scrollable container */
        padding: 0; /* No extra padding here, managed by scrollable-content-container */
    }

    .status-item {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid var(--card-border);
        border-radius: 10px;
        background-color: var(--background-color);
        position: relative; /* For delete button positioning */
    }

    .status-thumbnail-wrapper {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 15px;
        flex-shrink: 0; /* Prevent shrinking */
        border: 3px solid var(--primary-color); /* Highlight active status */
        cursor: pointer;
        position: relative;
    }

    .status-thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Ensures video fills the circular space */
        display: block;
    }

    .status-info {
        flex-grow: 1;
    }

    .status-info h5 {
        margin-bottom: 5px;
        color: var(--text-color);
    }

    .status-info p {
        font-size: 0.9em;
        color: var(--secondary-color);
        margin-bottom: 0;
    }

    .status-delete-btn-container {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }

    .status-download-btn {
        position: absolute;
        bottom: 10px; /* Position at the bottom */
        right: 10px; /* Position at the right */
        z-index: 10;
        color: var(--secondary-color); /* Adjust color as needed */
        font-size: 1.2em; /* Icon size */
        padding: 5px;
        border-radius: 50%;
        background-color: rgba(0,0,0,0.1); /* Slight background for visibility */
        transition: background-color 0.2s ease;
    }
    .status-download-btn:hover {
        background-color: rgba(0,0,0,0.2);
    }

    /* Modal for Fullscreen Video */
    .fullscreen-video-modal .modal-content {
        background-color: black; /* Dark background for video */
        border: none;
        height: 100vh; /* Full viewport height */
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .fullscreen-video-modal .modal-body {
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
        position: relative; /* Needed for absolute positioning of progress bar and play/pause icon */
        overflow: hidden; /* Prevent scrolling within the modal body */
    }
    .fullscreen-video-modal video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain; /* Ensure entire video is visible, letterboxing if needed */
        display: block;
        cursor: pointer; /* Indicate it's clickable */
    }
    /* Removed .fullscreen-video-modal .btn-close as it's no longer needed */

    /* Streamline Progress Bar */
    .status-progress-container {
        position: absolute;
        bottom: 0; /* Position at the very bottom of the modal body */
        left: 0;
        width: 100%;
        height: 5px; /* Thin line */
        background-color: rgba(255, 255, 255, 0.3); /* Light grey track */
        z-index: 1090; /* Above video */
    }

    .status-progress-bar {
        height: 100%;
        width: 0%; /* Starts at 0 */
        background-color: var(--primary-color); /* Green progress */
        transition: width 0.1s linear; /* Smooth movement */
    }

    /* Play/Pause Icon Overlay */
    .play-pause-icon-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3em; /* Large icon */
        color: white;
        opacity: 0; /* Hidden by default */
        transition: opacity 0.2s ease-out; /* Fade in/out */
        pointer-events: none; /* Allow clicks to pass through to the video */
        z-index: 1095; /* Above progress bar */
    }

    .play-pause-icon-overlay.show {
        opacity: 0.8;
    }


    /* Alert container positioning */
    .alert-container {
        position: fixed; /* Fixed position for alerts */
        top: 70px; /* Below navbar */
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 600px;
        z-index: 1050; /* Above all other content */
        text-align: center;
    }

    /* New: Floating Upload Button */
    .floating-upload-button-container {
        position: fixed;
        bottom: calc(var(--footer-height) + 20px); /* Adjust 20px for padding above footer */
        left: 50%;
        transform: translateX(-50%);
        z-index: 1040; /* Above scrollable content, below alerts */
        width: 90%; /* Max width for mobile */
        max-width: 300px; /* Max width for desktop */
        text-align: center;
    }

    .floating-upload-button-container .btn {
        width: 100%; /* Make button take full width of its container */
        padding: 12px 20px;
        font-size: 1.1em;
        border-radius: 50px; /* Pill shape */
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }


    /* Responsive adjustments */
    @media (min-width: 768px) {
        .fixed-top-title-container {
            padding-top: 70px;
            padding-bottom: 15px;
        }
        .fixed-top-title-container h1 {
            font-size: 2.2em; /* Larger title on desktop */
        }
        .scrollable-content-container {
            padding: 20px 30px; /* More horizontal padding on desktop */
        }
    }
</style>

{# Fixed Top Container: Page Title #}
<div class="fixed-top-title-container" id="fixedTopTitleContainer">
    <h1 class="text-center">Status Updates</h1>
</div>

{# Alerts will be positioned fixed, so they don't need to be in a container #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="alert-container">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message | safe }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{# Scrollable Content Container #}
<div class="scrollable-content-container" id="scrollableContentContainer">
    <div class="status-feed-inner-content">
        {% if statuses %}
            {% for status in statuses %}
            <div class="status-item">
                <div class="status-thumbnail-wrapper" data-video-src="/{{ status.file_path }}" data-status-index="{{ loop.index0 }}">
                    {% if status.profilePhoto %}
                        <img src="/{{ status.profilePhoto }}" alt="{{ status.fullName }} Profile" class="status-thumbnail">
                    {% else %}
                        <img src="{{ url_for('static', filename='img/default_profile.png') }}" alt="Default Profile" class="status-thumbnail">
                    {% endif %}
                </div>
                <div class="status-info">
                    <h5>{{ status.fullName }}</h5>
                    <p>Posted: {{ moment(status.upload_time).fromNow() }}</p>
                    <p>Expires: {{ moment(status.expires_at).calendar() }}</p>
                </div>
                {# Delete Button for Status - Visible to Admin OR the Uploader #}
                {% if current_user.is_admin or (status.uploader_user_id and current_user.id == status.uploader_user_id) %}
                    <div class="status-delete-btn-container">
                        <form action="{{ url_for('admin_delete_user_status', member_id=status.member_id) }}" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this status?');">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </div>
                {% endif %}
                {# Download Button for Status #}
                {% if status.file_path %}
                    <a href="/{{ status.file_path }}" download class="status-download-btn" title="Download Status Video">
                        <i class="fas fa-download"></i>
                    </a>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p class="text-center text-muted">No active family statuses right now. Check back later!</p>
        {% endif %}
    </div>
</div>

{# Floating Upload Video Status Button #}
<div class="floating-upload-button-container">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadVideoModal">
        <i class="fas fa-plus-circle me-2"></i> Upload Video Status
    </button>
</div>

{# Fullscreen Video Modal #}
<div class="modal fade fullscreen-video-modal" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen"> {# Use modal-fullscreen for full screen #}
        <div class="modal-content">
            {# Removed modal-header and its btn-close #}
            <div class="modal-body">
                <video id="statusVideoPlayer" autoplay playsinline> {# Removed 'controls' attribute #}
                    Your browser does not support the video tag.
                </video>
                <div class="status-progress-container">
                    <div class="status-progress-bar" id="statusProgressBar"></div>
                </div>
                <i id="playPauseIcon" class="play-pause-icon-overlay fas"></i>
            </div>
        </div>
    </div>
</div>

{# Video Upload Modal (Moved from my_profile.html) #}
<div class="modal fade" id="uploadVideoModal" tabindex="-1" aria-labelledby="uploadVideoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadVideoModalLabel">Upload Video Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="videoUploadForm" action="{{ url_for('upload_status_video') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="video_file" class="form-label">Select Video File</label>
                        <input class="form-control" type="file" id="video_file" name="video_file" accept="video/*" required>
                        <small class="form-text text-muted">Max file size 5MB. Supported formats: MP4, MOV, AVI, WEBM.</small>
                    </div>
                    <div id="videoUploadMessage" class="mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="uploadVideoBtn">Upload Video</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const videoModalElement = document.getElementById('videoModal');
        const videoModal = new bootstrap.Modal(videoModalElement); // Initialize Bootstrap Modal instance
        const statusVideoPlayer = document.getElementById('statusVideoPlayer');
        const statusProgressBar = document.getElementById('statusProgressBar');
        const playPauseIcon = document.getElementById('playPauseIcon');
        const statusItems = document.querySelectorAll('.status-thumbnail-wrapper');
        let currentStatusIndex = -1;
        const statusesData = [];

        // Populate statusesData array on load
        statusItems.forEach((item, index) => {
            statusesData.push({
                videoSrc: item.getAttribute('data-video-src'),
                index: index
            });

            // Add click listener to each thumbnail
            item.addEventListener('click', () => {
                currentStatusIndex = index;
                playCurrentStatus();
            });
        });

        function playCurrentStatus() {
            if (currentStatusIndex >= 0 && currentStatusIndex < statusesData.length) {
                const status = statusesData[currentStatusIndex];
                if (status.videoSrc) {
                    statusVideoPlayer.src = status.videoSrc;
                    statusVideoPlayer.load();
                    statusVideoPlayer.play();
                    videoModal.show(); // Show the modal
                } else {
                    // If current status has no video, try next or close
                    playNextStatus();
                }
            } else {
                // No more videos or invalid index, close modal
                videoModal.hide();
            }
        }

        function playNextStatus() {
            currentStatusIndex++;
            if (currentStatusIndex < statusesData.length) {
                playCurrentStatus();
            } else {
                // No more videos, close modal
                videoModal.hide();
            }
        }

        function playPreviousStatus() {
            currentStatusIndex--;
            if (currentStatusIndex >= 0) {
                playCurrentStatus();
            } else {
                // No previous videos, close modal
                videoModal.hide();
            }
        }


        // Event listener for when a video ends
        statusVideoPlayer.addEventListener('ended', () => {
            playNextStatus();
        });

        // Event listener for when the modal is hidden
        videoModalElement.addEventListener('hide.bs.modal', function () {
            statusVideoPlayer.pause();
            statusVideoPlayer.currentTime = 0;
            statusVideoPlayer.src = ""; // Clear source to prevent background playback
            statusProgressBar.style.width = '0%'; // Reset progress bar
            currentStatusIndex = -1; // Reset index
        });

        // Update progress bar
        statusVideoPlayer.addEventListener('timeupdate', () => {
            if (statusVideoPlayer.duration) {
                const progress = (statusVideoPlayer.currentTime / statusVideoPlayer.duration) * 100;
                statusProgressBar.style.width = `${progress}%`;
            }
        });

        // Play/Pause on video tap
        statusVideoPlayer.addEventListener('click', () => {
            if (statusVideoPlayer.paused) {
                statusVideoPlayer.play();
                showPlayPauseIcon('play');
            } else {
                statusVideoPlayer.pause();
                showPlayPauseIcon('pause');
            }
        });

        let playPauseIconTimeout;
        function showPlayPauseIcon(action) {
            clearTimeout(playPauseIconTimeout);
            playPauseIcon.className = `play-pause-icon-overlay fas fa-${action}`;
            playPauseIcon.classList.add('show');

            playPauseIconTimeout = setTimeout(() => {
                playPauseIcon.classList.remove('show');
            }, 700); // Fade out after 0.7 seconds
        }

        // --- Swipe Down to Close Modal (WhatsApp-like) ---
        let touchstartY = 0;
        let touchendY = 0;
        let touchstartX = 0; // Added for horizontal swipe
        let touchendX = 0;   // Added for horizontal swipe
        const minSwipeDistance = 50; // Minimum vertical/horizontal distance for a swipe to be recognized

        videoModalElement.addEventListener('touchstart', e => {
            touchstartY = e.changedTouches[0].screenY;
            touchstartX = e.changedTouches[0].screenX; // Capture start X
        }, { passive: true });

        videoModalElement.addEventListener('touchmove', e => {
            // No need to do anything here for this implementation, gesture handled on touchend
        }, { passive: true });

        videoModalElement.addEventListener('touchend', e => {
            touchendY = e.changedTouches[0].screenY;
            touchendX = e.changedTouches[0].screenX; // Capture end X
            handleGesture();
        });

        function handleGesture() {
            const diffY = touchendY - touchstartY;
            const diffX = touchendX - touchstartX;

            if (Math.abs(diffY) > Math.abs(diffX) && diffY > minSwipeDistance) {
                // Vertical swipe down detected
                videoModal.hide();
            } else if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > minSwipeDistance) {
                // Horizontal swipe detected
                if (diffX < 0) { // Swiped left (touchendX < touchstartX)
                    playNextStatus();
                } else { // Swiped right (touchendX > touchstartX)
                    playPreviousStatus();
                }
            }
        }


        // --- Dynamic positioning for the fixed scrollable container ---
        const fixedTopTitleContainer = document.getElementById('fixedTopTitleContainer');
        const scrollableContentContainer = document.getElementById('scrollableContentContainer');
        const footerHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--footer-height')) || 60; // From base.html CSS var

        function adjustScrollableContainerPosition() {
            if (fixedTopTitleContainer && scrollableContentContainer) {
                const topHeight = fixedTopTitleContainer.offsetHeight;

                // Set the top and bottom offsets for the fixed scrollable container
                scrollableContentContainer.style.top = `${topHeight}px`;

                // Calculate bottom space needed: footer height + floating button container height + some buffer
                const floatingButtonContainer = document.querySelector('.floating-upload-button-container');
                const floatingButtonHeight = floatingButtonContainer ? floatingButtonContainer.offsetHeight : 0;
                const bottomBuffer = 30; // Additional space between scrollable content and floating button
                scrollableContentContainer.style.bottom = `${footerHeight + floatingButtonHeight + bottomBuffer}px`;
            }
        }

        // Adjust on load and on window resize
        adjustScrollableContainerPosition();
        window.addEventListener('resize', adjustScrollableContainerPosition);


        // Auto-hide flash messages
        const flashMessages = document.querySelectorAll('.flash');
        flashMessages.forEach(function(flash) {
            setTimeout(function() {
                flash.style.opacity = '0';
                flash.style.transition = 'opacity 0.5s ease-out';
                setTimeout(function() {
                    flash.remove();
                }, 500);
            }, 5000);
        });

        // Handle video upload form submission via AJAX (Moved from my_profile.html)
        const videoUploadForm = document.getElementById('videoUploadForm');
        const uploadVideoModal = new bootstrap.Modal(document.getElementById('uploadVideoModal'));
        const videoUploadMessage = document.getElementById('videoUploadMessage');
        const uploadVideoBtn = document.getElementById('uploadVideoBtn');

        if (videoUploadForm) {
            videoUploadForm.addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent default form submission

                const formData = new FormData(videoUploadForm);

                // Show loading state
                uploadVideoBtn.disabled = true;
                uploadVideoBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
                videoUploadMessage.style.display = 'none'; // Hide previous messages

                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json()) // Expecting JSON response
                .then(data => {
                    videoUploadMessage.style.display = 'block';
                    if (data.success) {
                        videoUploadMessage.className = 'alert alert-success';
                        videoUploadMessage.innerHTML = data.message;
                        // Clear file input
                        document.getElementById('video_file').value = '';
                        // Optionally, auto-close modal and reload/update profile
                        setTimeout(() => {
                            uploadVideoModal.hide();
                            window.location.reload(); // Simple reload to show new video
                        }, 1500);
                    } else {
                        videoUploadMessage.className = 'alert alert-danger';
                        videoUploadMessage.innerHTML = data.message;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    videoUploadMessage.style.display = 'block';
                    videoUploadMessage.className = 'alert alert-danger';
                    videoUploadMessage.innerHTML = 'An error occurred during upload. Please try again.';
                })
                .finally(() => {
                    uploadVideoBtn.disabled = false;
                    uploadVideoBtn.innerHTML = 'Upload Video';
                });
            });
        }
    });
</script>
{% endblock %}

{% block footer %}{% endblock %}