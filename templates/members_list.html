{% extends 'base.html' %}

{% block title %}Friends{% endblock %} {# Changed title here #}

{% block content %}
<style>
    /* Ensure HTML and Body take full height and manage overflow */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Crucial: Prevents main body scroll */
    }

    body {
        display: flex; /* Use flexbox for main body layout */
        flex-direction: column; /* Stack children vertically */
        min-height: 100vh; /* Ensure body takes full viewport height */
        background-color: var(--background-color); /* Match background */
        color: var(--text-color); /* Match text color */
    }

    /* Main Members List Container (Scrollable) */
    .members-list-container {
        position: fixed; /* Make it fixed */
        top: 70px; /* Space for the main navbar */
        left: 0;
        right: 0;
        width: 100%; /* Ensure it spans full width */
        background-color: var(--background-color); /* Match background */
        border: none; /* No border */
        box-shadow: none; /* No shadow */
        overflow-y: auto; /* THIS MAKES IT SCROLLABLE */
        box-sizing: border-box;
        padding: 20px; /* Padding inside the scrollable area */
        height: calc(100vh - 70px); /* Adjust height to fill remaining viewport */
    }

    /* Specific styles for the search bar */
    .search-bar {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: var(--background-color); /* Match background */
        padding-bottom: 15px; /* Space below search bar */
        margin-bottom: 15px; /* Space between search bar and list */
        border-bottom: 1px solid var(--border-color); /* Subtle separator */
    }

    /* Member card styling */
    .member-card {
        background-color: var(--card-background-color);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        margin-bottom: 15px;
        padding: 15px;
        display: flex;
        align-items: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out;
    }

    .member-card:hover {
        transform: translateY(-3px);
    }

    .member-card img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid var(--primary-color);
        margin-right: 15px;
    }

    .member-info {
        flex-grow: 1;
    }

    .member-info h5 {
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--text-color);
    }

    .member-info p {
        margin-bottom: 0;
        color: var(--secondary-text-color);
        font-size: 0.9em;
    }

    .member-actions {
        display: flex;
        gap: 10px; /* Space between buttons */
    }

    .member-actions .btn {
        padding: 8px 15px;
        font-size: 0.9em;
        border-radius: 8px;
        transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
    }

    .member-actions .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .member-actions .btn-primary:hover {
        background-color: var(--primary-color-dark);
        border-color: var(--primary-color-dark);
        transform: translateY(-1px);
    }

    .member-actions .btn-info {
        background-color: #17a2b8; /* Bootstrap info blue */
        border-color: #17a2b8;
        color: white;
    }

    .member-actions .btn-info:hover {
        background-color: #138496;
        border-color: #138496;
        transform: translateY(-1px);
    }

    /* Style for the "Active Status" badge */
    .active-status-badge {
        font-size: 0.75em;
        padding: 3px 8px;
        border-radius: 5px;
        background-color: #28a745; /* Green */
        color: white;
        margin-left: 10px;
        vertical-align: middle;
    }

    /* Dropdown specific styles */
    .dropdown-menu {
        background-color: var(--card-background-color);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        z-index: 1000; /* Ensure dropdown is on top */
    }

    .dropdown-item {
        color: var(--text-color);
        padding: 10px 15px;
        transition: background-color 0.2s ease-in-out;
    }

    .dropdown-item:hover {
        background-color: var(--primary-color-light);
        color: white;
    }

    .dropdown-toggle::after {
        vertical-align: middle;
    }
</style>

<div class="members-list-container">
    <div class="container">
        <h2 class="text-center mb-4 text-3xl font-bold text-blue-500">All Members</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="alert-container mb-4">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show flash" role="alert">
                            {{ message | safe }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="search-bar mb-4">
            <input type="text" id="memberSearch" class="form-control p-3 rounded-lg border border-gray-600 bg-gray-700 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500" placeholder="Search members by name or username...">
        </div>

        <div id="membersList" class="grid grid-cols-1 gap-4">
            <!-- Members will be rendered here by JavaScript -->
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // This data is passed from Flask and available globally in the template
        const allMembers = {{ members | tojson | safe }};
        const currentUserId = {{ current_user.id | tojson | safe }}; // Get current user's ID

        const membersListDiv = document.getElementById('membersList');
        const memberSearchInput = document.getElementById('memberSearch');

        function renderMembers(membersToRender) {
            membersListDiv.innerHTML = ''; // Clear existing list
            if (membersToRender.length === 0) {
                membersListDiv.innerHTML = '<p class="text-center text-gray-400">No members found matching your search.</p>';
                return;
            }

            membersToRender.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card';

                let profilePhotoSrc = member.profilePhotoUrl;
                if (!profilePhotoSrc) {
                    profilePhotoSrc = "{{ url_for('static', filename='img/default_profile.png') }}";
                }

                memberCard.innerHTML = `
                    <img src="${profilePhotoSrc}" alt="${member.fullName} Profile Photo">
                    <div class="member-info">
                        <h5>${member.fullName}
                            ${member.has_active_video ? '<span class="active-status-badge">Active Status</span>' : ''}
                        </h5>
                        <p>${member.association}</p>
                        ${member.username ? `<p class="text-xs text-gray-500">@${member.username}</p>` : ''}
                    </div>
                    <div class="member-actions">
                        <a href="{{ url_for('member_detail', member_id=0) }}${member.id}" class="btn btn-info">View Profile</a>
                        ${member.user_id && member.user_id != currentUserId ? `
                            <div class="dropdown">
                                <button class="btn btn-success dropdown-toggle" type="button" id="dropdownMenuButton${member.id}" data-bs-toggle="dropdown" aria-expanded="false">
                                    Invite to Game
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton${member.id}">
                                    <li>
                                        <form action="{{ url_for('invite_game', game_name='chess', recipient_id=0) }}${member.user_id}" method="post">
                                            <button type="submit" class="dropdown-item">Chess</button>
                                        </form>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('invite_game', game_name='racing', recipient_id=0) }}${member.user_id}" method="post">
                                            <button type="submit" class="dropdown-item">Racing Game</button>
                                        </form>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('invite_game', game_name='board_games', recipient_id=0) }}${member.user_id}" method="post">
                                            <button type="submit" class="dropdown-item">Board Games</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                membersListDiv.appendChild(memberCard);
            });
        }

        function filterAndSortMembers() {
            const query = memberSearchInput.value.toLowerCase();
            let filteredMembers = allMembers.filter(member => {
                const fullName = member.fullName ? member.fullName.toLowerCase() : '';
                const username = member.username ? member.username.toLowerCase() : '';
                const association = member.association ? member.association.toLowerCase() : '';
                return fullName.includes(query) || username.includes(query) || association.includes(query);
            });

            // Sort logic (prioritize exact matches, then starts with, then contains, then alphabetical)
            filteredMembers.sort((a, b) => {
                const aFullName = a.fullName || '';
                const bFullName = b.fullName || '';
                const aUsername = a.username || '';
                const bUsername = b.username || '';

                const aFullNameExact = aFullName === query;
                const bFullNameExact = bFullName === query;
                const aUsernameExact = aUsername === query;
                const bUsernameExact = bUsername === query;

                const aFullNameStarts = aFullName.startsWith(query);
                const bFullNameStarts = bFullName.startsWith(query);
                const aUsernameStarts = aUsername.startsWith(query);
                const bUsernameStarts = bUsername.startsWith(query);

                const aFullNameIncludes = aFullName.includes(query);
                const bFullNameIncludes = bFullName.includes(query);
                const aUsernameIncludes = aUsername.includes(query);
                const bUsernameIncludes = aUsername.includes(query);

                // Priority 1: Exact match on full name or username
                if (aFullNameExact && !bFullNameExact) return -1;
                if (!aFullNameExact && bFullNameExact) return 1;
                if (aUsernameExact && !bUsernameExact) return -1;
                if (!aUsernameExact && bUsernameExact) return 1;

                // Priority 2: Starts with on full name or username
                if (aFullNameStarts && !bFullNameStarts) return -1;
                if (!aFullNameStarts && bFullNameStarts) return 1;
                if (aUsernameStarts && !bUsernameStarts) return -1;
                if (!aUsernameStarts && bUsernameStarts) return 1;

                // Priority 3: Full name contains
                if (aFullNameIncludes && !bFullNameIncludes) return -1;
                if (!aFullNameIncludes && bFullNameIncludes) return 1;

                // Priority 4: Username contains
                if (aUsernameIncludes && !bUsernameIncludes) return -1;
                if (!aUsernameIncludes && bUsernameIncludes) return 1;

                // Default: alphabetical by full name if no other criteria differentiate
                return aFullName.localeCompare(bFullName);
            });

            renderMembers(filteredMembers);
        }

        // Event listener for input changes in the search box
        memberSearchInput.addEventListener('input', filterAndSortMembers);

        // Initial render of all members when the page loads
        // Sort initially by full name
        const sortedInitialMembers = [...allMembers].sort((a, b) => {
            const aFullName = a.fullName || '';
            const bFullName = b.fullName || '';
            return aFullName.localeCompare(bFullName);
        });
        renderMembers(sortedInitialMembers);

        // Auto-hide flash messages (copied from base.html for consistency)
        const flashMessages = document.querySelectorAll('.flash');
        flashMessages.forEach(function(flash) {
            setTimeout(function() {
                flash.style.opacity = '0';
                flash.style.transition = 'opacity 0.5s ease-out';
                setTimeout(function() {
                    flash.remove();
                }, 500);
            }, 5000);
        });
    });
</script>
{% endblock %}
ullName.toLowerCase() : '';
                const username = member.username ? member.username.toLowerCase() : '';
                const association = member.association ? member.association.toLowerCase() : '';
                return fullName.includes(query) || username.includes(query) || association.includes(query);
            });

            // Sort logic (prioritize exact matches, then starts with, then contains, then alphabetical)
            filteredMembers.sort((a, b) => {
                const aFullName = a.fullName || '';
                const bFullName = b.fullName || '';
                const aUsername = a.username || '';
                const bUsername = b.username || '';

                const aFullNameExact = aFullName === query;
                const bFullNameExact = bFullName === query;
                const aUsernameExact = aUsername === query;
                const bUsernameExact = bUsername === query;

                const aFullNameStarts = aFullName.startsWith(query);
                const bFullNameStarts = bFullName.startsWith(query);
                const aUsernameStarts = aUsername.startsWith(query);
                const bUsernameStarts = bUsername.startsWith(query);

                const aFullNameIncludes = aFullName.includes(query);
                const bFullNameIncludes = bFullName.includes(query);
                const aUsernameIncludes = aUsername.includes(query);
                const bUsernameIncludes = bUsername.includes(query);

                // Priority 1: Exact match on full name or username
                if (aFullNameExact && !bFullNameExact) return -1;
                if (!aFullNameExact && bFullNameExact) return 1;
                if (aUsernameExact && !bUsernameExact) return -1;
                if (!aUsernameExact && bUsernameExact) return 1;

                // Priority 2: Starts with on full name or username
                if (aFullNameStarts && !bFullNameStarts) return -1;
                if (!aFullNameStarts && bFullNameStarts) return 1;
                if (aUsernameStarts && !bUsernameStarts) return -1;
                if (!aUsernameStarts && bUsernameStarts) return 1;

                // Priority 3: Full name contains
                if (aFullNameIncludes && !bFullNameIncludes) return -1;
                if (!aFullNameIncludes && bFullNameIncludes) return 1;

                // Priority 4: Username contains
                if (aUsernameIncludes && !bUsernameIncludes) return -1;
                if (!aUsernameIncludes && bUsernameIncludes) return 1;

                // Default: alphabetical by full name if no other criteria differentiate
                return aFullName.localeCompare(bFullName);
            });

            renderMembers(filteredMembers);
        }

        // Event listener for input changes in the search box
        memberSearchInput.addEventListener('input', filterAndSortMembers);

        // Initial render of all members when the page loads
        // Sort initially by full name
        const sortedInitialMembers = [...allMembers].sort((a, b) => {
            const aFullName = a.fullName || '';
            const bFullName = b.fullName || '';
            return aFullName.localeCompare(bFullName);
        });
        renderMembers(sortedInitialMembers);

        // Auto-hide flash messages (copied from base.html for consistency)
        const flashMessages = document.querySelectorAll('.flash');
        flashMessages.forEach(function(flash) {
            setTimeout(function() {
                flash.style.opacity = '0';
                flash.style.transition = 'opacity 0.5s ease-out';
                setTimeout(function() {
                    flash.remove();
                }, 500);
            }, 5000);
        });
    });
</script>
{% endblock %}

