{% extends 'base.html' %}

{% block title %}Friends{% endblock %} {# Changed title here #}

{% block content %}
<style>
    /* Ensure HTML and Body take full height and manage overflow */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Crucial: Prevents main body scroll */
    }

    body {
        display: flex; /* Use flexbox for main body layout */
        flex-direction: column; /* Stack children vertically */
        min-height: 100vh; /* Ensure body takes full viewport height */
        background-color: var(--background-color); /* Match background */
        color: var(--text-color); /* Match text color */
    }

    /* Main Members List Container (Scrollable) */
    .members-list-container {
        position: fixed; /* Make it fixed */
        top: 70px; /* Space for the main navbar */
        left: 0;
        right: 0;
        width: 100%; /* Ensure it spans full width */
        background-color: var(--background-color); /* Match background */
        border: none; /* No border */
        box-shadow: none; /* No shadow */
        overflow-y: auto; /* THIS MAKES IT SCROLLABLE */
        box-sizing: border-box;
        padding: 20px; /* Padding inside the scrollable area */
        bottom: 60px; /* Space for the fixed footer */
    }

    /* Adjust container for smaller screens if needed */
    @media (max-width: 767.98px) {
        .members-list-container {
            padding: 10px; /* Less padding on small screens */
        }
    }

    /* Specific styles for the search bar */
    .search-bar {
        margin-bottom: 20px;
        padding: 10px;
        border-radius: 0.5rem;
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
    }
    .search-bar input {
        flex-grow: 1;
        border: none;
        background: transparent;
        color: var(--text-color);
        outline: none;
        padding: 5px 10px;
    }
    .search-bar input::placeholder {
        color: var(--text-color);
        opacity: 0.7;
    }
    .search-bar i {
        color: var(--text-color);
        margin-right: 10px;
        opacity: 0.7;
    }

    /* Member card styling */
    .member-card {
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 0.75rem;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .member-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    .member-card img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 50%;
        margin-right: 15px;
        border: 2px solid var(--primary-color);
    }
    .member-info {
        flex-grow: 1;
    }
    .member-info h5 {
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--text-color);
    }
    .member-info p {
        margin-bottom: 0;
        color: var(--text-color);
        font-size: 0.9em;
        opacity: 0.8;
    }
    .member-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-left: 15px;
    }
    .member-actions .btn {
        padding: 8px 12px;
        font-size: 0.85em;
        border-radius: 0.5rem;
        transition: background-color 0.2s, transform 0.2s;
    }
    .member-actions .btn:hover {
        transform: translateY(-1px);
    }

    /* Status indicator dot */
    .status-dot {
        width: 12px;
        height: 12px;
        background-color: #28a745; /* Green for active */
        border-radius: 50%;
        position: absolute;
        bottom: 0;
        right: 0;
        border: 2px solid var(--card-bg); /* Border to stand out from profile photo */
    }
    .profile-pic-wrapper {
        position: relative;
        width: 60px; /* Match img width */
        height: 60px; /* Match img height */
    }
</style>

<div class="members-list-container">
    <h2 class="mb-4 text-center">Friends and Family</h2>

    <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" id="memberSearch" placeholder="Search by name or username...">
    </div>

    <div id="membersList">
        {# Members will be rendered here by JavaScript #}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const memberSearchInput = document.getElementById('memberSearch');
        const membersListContainer = document.getElementById('membersList');

        // This data is passed from Flask (app.py)
        const allMembers = {{ members | tojson }};

        function renderMembers(membersToRender) {
            membersListContainer.innerHTML = ''; // Clear existing members
            if (membersToRender.length === 0) {
                membersListContainer.innerHTML = '<p class="text-center text-muted mt-3">No members found matching your search.</p>';
                return;
            }

            membersToRender.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.classList.add('member-card');

                let profilePhotoSrc = member.profilePhotoUrl;
                if (!profilePhotoSrc) {
                    profilePhotoSrc = "{{ url_for('static', filename='img/default_profile.png') }}";
                }

                memberCard.innerHTML = `
                    <div class="profile-pic-wrapper">
                        <img src="${profilePhotoSrc}" alt="${member.fullName} Profile Photo">
                        ${member.has_active_video ? '<span class="status-dot" title="Has active status"></span>' : ''}
                    </div>
                    <div class="member-info">
                        <h5>${member.fullName}</h5>
                        <p class="text-muted">${member.association}</p>
                        ${member.username ? `<p class="text-muted small">@${member.username}</p>` : ''}
                    </div>
                    <div class="member-actions">
                        <a href="{{ url_for('member_detail', member_id=0) }}${member.id}" class="btn btn-info btn-sm">View Profile</a>
                        ${member.isLinkedUser ? `
                            <a href="{{ url_for('messages_with', other_user_id=0) }}${member.user_id}" class="btn btn-primary btn-sm">Message</a>
                            ${member.user_id !== {{ current_user.id }} ? `
                                <div class="dropdown">
                                    <button class="btn btn-success btn-sm dropdown-toggle" type="button" id="dropdownMenuButton_${member.id}" data-bs-toggle="dropdown" aria-expanded="false">
                                        Invite to Game
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton_${member.id}">
                                        <li>
                                            <form action="{{ url_for('invite_game', game_name='chess', recipient_id=0) }}${member.user_id}" method="post">
                                                <button type="submit" class="dropdown-item">Chess</button>
                                            </form>
                                        </li>
                                        <li>
                                            <form action="{{ url_for('invite_game', game_name='racing', recipient_id=0) }}${member.user_id}" method="post">
                                                <button type="submit" class="dropdown-item">Racing Game</button>
                                            </form>
                                        </li>
                                        <li>
                                            <form action="{{ url_for('invite_game', game_name='board_games', recipient_id=0) }}${member.user_id}" method="post">
                                                <button type="submit" class="dropdown-item">Board Games</button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            ` : ''}
                        ` : ''}
                    </div>
                `;
                membersListContainer.appendChild(memberCard);
            });
        }

        function filterAndSortMembers() {
            const query = memberSearchInput.value.toLowerCase();
            let filteredMembers = allMembers.filter(member => {
                const fullName = member.fullName ? member.fullName.toLowerCase() : '';
                const username = member.username ? member.username.toLowerCase() : '';
                const association = member.association ? member.association.toLowerCase() : '';
                return fullName.includes(query) || username.includes(query) || association.includes(query);
            });

            // Sort members based on search query relevance and then alphabetically
            filteredMembers.sort((a, b) => {
                const aFullName = a.fullName ? a.fullName.toLowerCase() : '';
                const bFullName = b.fullName ? b.fullName.toLowerCase() : '';
                const aUsername = a.username ? a.username.toLowerCase() : '';
                const bUsername = b.username ? b.username.toLowerCase() : '';

                const aFullNameMatches = aFullName === query;
                const bFullNameMatches = bFullName === query;
                const aUsernameMatches = aUsername === query;
                const bUsernameMatches = bUsername === query;

                const aFullNameStarts = aFullName.startsWith(query);
                const bFullNameStarts = bFullName.startsWith(query);
                const aUsernameStarts = aUsername.startsWith(query);
                const bUsernameStarts = bUsername.startsWith(query);

                const aFullNameIncludes = aFullName.includes(query);
                const bFullNameIncludes = bFullName.includes(query);
                const aUsernameIncludes = aUsername.includes(query);
                const bUsernameIncludes = bUsername.includes(query);

                // Priority 1: Exact match (full name or username)
                if (aFullNameMatches && !bFullNameMatches) return -1;
                if (!aFullNameMatches && bFullNameMatches) return 1;
                if (aUsernameMatches && !bUsernameMatches) return -1;
                if (!aUsernameMatches && bUsernameMatches) return 1;

                // Priority 2: Starts with (full name or username)
                if (aFullNameStarts && !bFullNameStarts) return -1;
                if (!aFullNameStarts && bFullNameStarts) return 1;
                if (aUsernameStarts && !bUsernameStarts) return -1;
                if (!aUsernameStarts && bUsernameStarts) return 1;

                // Priority 3: Full name contains
                if (aFullNameIncludes && !bFullNameIncludes) return -1;
                if (!aFullNameIncludes && bFullNameIncludes) return 1;

                // Priority 4: Username contains
                if (aUsernameIncludes && !bUsernameIncludes) return -1;
                if (!aUsernameIncludes && bUsernameIncludes) return 1;

                // Default: alphabetical by full name if no other criteria differentiate
                return aFullName.localeCompare(bFullName);
            });

            renderMembers(filteredMembers);
        }

        // Event listener for input changes in the search box
        memberSearchInput.addEventListener('input', filterAndSortMembers);

        // Initial render of all members when the page loads
        // Sort initially by full name
        const sortedInitialMembers = [...allMembers].sort((a, b) => {
            const aFullName = a.fullName || '';
            const bFullName = b.fullName || '';
            return aFullName.localeCompare(bFullName);
        });
        renderMembers(sortedInitialMembers);

        // Auto-hide flash messages (copied from base.html for consistency)
        const flashMessages = document.querySelectorAll('.flash');
        flashMessages.forEach(function(flash) {
            setTimeout(function() {
                flash.style.opacity = '0';
                flash.style.transition = 'opacity 0.5s ease-out';
                setTimeout(function() {
                    flash.remove();
                }, 500);
            }, 5000);
        });
    });
</script>
{% endblock %}
