{% extends 'base.html' %}

{% block title %}Settings{% endblock %}

{% block content %}
<style>
    /* Ensure body padding for fixed elements */
    body {
        padding-top: 0; /* Reset base.html padding-top as we'll manage here */
        padding-bottom: var(--footer-height); /* Space for fixed footer */
    }

    /* Fixed Top Container for Chat Background Settings */
    .fixed-settings-top-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: var(--background-color); /* Match page background */
        color: var(--text-color);
        padding: 15px 20px;
        box-shadow: none; /* No shadow */
        border: none; /* No border */
        z-index: 1000; /* Ensure it's above scrollable content */
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding-top: 70px; /* Space for main navbar */
        padding-bottom: 20px; /* Padding at the bottom of this container */
        border-bottom: 1px solid var(--card-border); /* Separator between fixed sections */
        box-sizing: border-box; /* Include padding in width/height */
    }

    /* New style for the header with theme switch */
    .settings-header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        max-width: 600px; /* Match max-width of alert-container for consistency */
        margin-bottom: 15px; /* Space below header */
    }

    .settings-header-container h2 {
        margin-bottom: 0; /* Remove default margin */
        flex-grow: 1; /* Allow title to take available space */
        text-align: center; /* Center the title */
    }

    .fixed-settings-top-container h5 {
        margin-top: 20px;
        margin-bottom: 15px;
        font-size: 1.2em;
        text-align: center; /* Ensure "Chat Background" is centered */
        width: 100%;
    }

    .fixed-settings-top-container .image-previews {
        display: flex;
        flex-direction: column; /* Stack images on mobile */
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        width: 100%;
    }

    .fixed-settings-top-container .image-previews .preview-item {
        text-align: center;
    }

    .fixed-settings-top-container .image-previews img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px; /* Slightly rounded corners for preview images */
        border: 1px solid var(--input-border);
    }

    .fixed-settings-top-container form {
        width: 100%; /* Forms take full width */
        max-width: 400px; /* Limit form width */
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 15px; /* Space between forms/buttons */
    }

    .fixed-settings-top-container .btn-group-vertical {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .fixed-settings-top-container .btn {
        width: 100%; /* Buttons take full width of their container */
        padding: 10px 15px;
        border-radius: 8px;
    }

    /* Fixed Bottom Container for Account Actions */
    .fixed-settings-bottom-container {
        position: fixed; /* Keep it fixed */
        bottom: var(--footer-height); /* Position above the fixed footer */
        left: 0;
        width: 100%;
        background-color: var(--background-color); /* Match page background */
        color: var(--text-color);
        padding: 15px 20px;
        box-shadow: none; /* No shadow */
        border: none; /* No border */
        z-index: 999; /* Below top fixed section, above footer */
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        border-top: 1px solid var(--card-border); /* Separator from scrollable content */
        padding-top: 20px;
        padding-bottom: 20px;
        box-sizing: border-box; /* Include padding in width/height */
    }

    .fixed-settings-bottom-container h5 {
        margin-bottom: 15px;
        font-size: 1.2em;
        text-align: center;
        width: 100%;
    }

    .fixed-settings-bottom-container .btn-group {
        display: flex;
        flex-wrap: wrap; /* Allow buttons to wrap */
        justify-content: center;
        gap: 10px;
        width: 100%;
        max-width: 400px;
    }

    /* Adjust content padding to avoid overlap with fixed sections */
    .content {
        /* This padding will be dynamically set by JS to account for both fixed top and bottom */
        padding-top: 0; /* Reset base.html padding-top */
        padding-bottom: 0; /* Reset base.html padding-bottom */
        overflow-y: auto; /* Enable scrolling for content in between */
        position: fixed; /* Make content fixed and scrollable */
        left: 0;
        right: 0;
        width: 100%;
        box-sizing: border-box;
    }

    /* Adjust alert container position */
    .alert-container {
        top: 70px; /* Default position, adjust if needed based on fixed header dynamic height */
    }

    /* Responsive adjustments */
    @media (min-width: 768px) {
        .fixed-settings-top-container {
            padding-top: 70px; /* Maintain space for main navbar */
            min-height: auto; /* Allow height to adjust to content */
            justify-content: flex-start; /* Align content to top */
        }
        .fixed-settings-top-container .image-previews {
            flex-direction: row; /* Align images side-by-side on desktop */
            justify-content: center;
        }
        .fixed-settings-top-container .btn-group-vertical {
            flex-direction: row; /* Buttons side-by-side */
            justify-content: center;
            flex-wrap: wrap;
        }
        .fixed-settings-top-container .btn {
            width: auto; /* Buttons can take natural width */
            flex-grow: 1; /* Allow them to grow if space permits */
        }

        .fixed-settings-bottom-container {
            /* Keep fixed positioning, but ensure it's at the bottom of the viewport */
            position: fixed;
            bottom: var(--footer-height);
            left: 0;
            width: 100%;
            border-top: 1px solid var(--card-border); /* Re-add border if removed */
            margin-top: 0; /* No extra margin */
        }
        .fixed-settings-bottom-container .btn-group {
            justify-content: center;
        }
    }
</style>

{# Fixed Top Container: Account Settings & Chat Background #}
<div class="fixed-settings-top-container" id="fixedSettingsTopContainer">
    <div class="settings-header-container">
        {# Dark Mode Switch - Far Left #}
        <div class="form-check form-switch me-auto"> {# ms-auto pushes it left #}
            <input class="form-check-input" type="checkbox" id="themeSwitch" {% if g.user_theme == 'dark' %}checked{% endif %}>
            <label class="form-check-label text-nowrap" for="themeSwitch">Dark Mode</label>
        </div>
        <h2 class="card-title text-center flex-grow-1">Account Settings</h2>
        <div></div> {# Empty div to balance flexbox, if needed, or remove if not #}
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert-container mb-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message | safe }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <h5>Chat Background</h5>
    <div class="image-previews">
        <div class="preview-item">
            <p class="text-muted small mb-1">Current Chat Background:</p>
            {% if g.user_chat_background %}
                <img src="/{{ g.user_chat_background }}" alt="Current Chat Background">
            {% else %}
                <img src="{{ url_for('static', filename='img/default_chat_bg.jpg') }}" alt="Default Chat Background">
            {% endif %}
        </div>
        <div class="preview-item">
            <p class="text-muted small mb-1">Your Profile Photo:</p>
            {% if profile_photo_path %} {# Assuming profile_photo_path is passed from backend #}
                <img src="/{{ profile_photo_path }}" alt="Your Profile Photo">
            {% else %}
                <img src="{{ url_for('static', filename='img/default_profile.png') }}" alt="Default Profile Photo">
            {% endif %}
        </div>
    </div>

    <form action="{{ url_for('update_chat_background') }}" method="POST" enctype="multipart/form-data" class="mb-3">
        <div class="mb-3">
            <label for="background_file" class="form-label">Upload New Background Image</label>
            <input class="form-control" type="file" id="background_file" name="background_file" accept="image/*">
            <small class="form-text text-muted">Max file size 5MB. Supported: PNG, JPG, JPEG, GIF.</small>
        </div>
        <button type="submit" name="action" value="upload" class="btn btn-primary me-2">Upload & Set</button>
        <button type="submit" name="action" value="use_profile_photo" class="btn btn-info" {% if not profile_photo_path %}disabled{% endif %}>Use Profile Photo as Background</button>
    </form>

    <div class="btn-group-vertical">
        <form action="{{ url_for('update_chat_background') }}" method="POST">
            <button type="submit" name="action" value="clear" class="btn btn-secondary">Clear Background</button>
        </form>
    </div>
</div>

{# Fixed Bottom Container: Account Actions #}
<div class="fixed-settings-bottom-container" id="fixedSettingsBottomContainer">
    <h5>Account Actions</h5>
    <div class="btn-group">
        {# Edit My Details button - NEW LOCATION #}
        <a href="{{ url_for('edit_my_profile') }}" class="btn btn-warning">Edit My Details</a>
        {# Link to a dedicated change password page #}
        <a href="{{ url_for('change_password') }}" class="btn btn-info">Change Password</a>
        {# Logout Button - next to Change Password #}
        <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-hide flash messages
        const flashMessages = document.querySelectorAll('.flash');
        flashMessages.forEach(function(flash) {
            setTimeout(function() {
                flash.style.opacity = '0';
                flash.style.transition = 'opacity 0.5s ease-out';
                setTimeout(function() {
                    flash.remove();
                }, 500);
            }, 5000);
        });

        // Theme Switch Logic (Moved from base.html)
        const themeSwitch = document.getElementById('themeSwitch');
        if (themeSwitch) {
            // Set initial state of switch based on g.user_theme
            const initialTheme = "{{ g.user_theme if g.user_theme else 'light' }}";
            document.body.className = initialTheme + '-theme'; // Ensure body class is set on page load

            themeSwitch.checked = (initialTheme === 'dark');

            themeSwitch.addEventListener('change', function() {
                const theme = this.checked ? 'dark' : 'light';
                document.body.className = theme + '-theme'; // Apply theme class to body

                fetch('/update-theme-preference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ theme: theme })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Theme updated:', data.message);
                    // Optionally, show a temporary success message to the user
                })
                .catch(error => {
                    console.error('Error updating theme:', error);
                    // Optionally, show a temporary error message to the user
                });
            });
        }

        // --- Dynamic positioning for the content area between fixed top and bottom ---
        const fixedSettingsTopContainer = document.getElementById('fixedSettingsTopContainer');
        const fixedSettingsBottomContainer = document.getElementById('fixedSettingsBottomContainer');
        const contentArea = document.querySelector('.content'); // This is the block content is rendered into
        const navbarHeight = 70; // From base.html CSS var

        function adjustContentPadding() {
            if (fixedSettingsTopContainer && fixedSettingsBottomContainer && contentArea) {
                const topHeight = fixedSettingsTopContainer.offsetHeight;
                const bottomHeight = fixedSettingsBottomContainer.offsetHeight;
                const footerHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--footer-height')) || 60;

                // Set padding-top of the content area to be below the fixed top container
                // And padding-bottom to be above the fixed bottom container + footer
                contentArea.style.paddingTop = `${topHeight}px`;
                contentArea.style.paddingBottom = `${bottomHeight + footerHeight}px`;
                
                // Ensure the content area itself is not fixed, allowing it to scroll if needed
                contentArea.style.position = 'static'; /* Reset to static or relative for normal flow */
                contentArea.style.height = 'auto'; /* Allow height to be determined by content */
                contentArea.style.overflowY = 'visible'; /* Allow content to overflow and body to scroll */
            }
        }

        // Adjust on load and on window resize
        adjustContentPadding();
        window.addEventListener('resize', adjustContentPadding);

        // Re-adjust after images load or content changes that might affect height
        window.addEventListener('load', adjustContentPadding);
    });
</script>
{% endblock %}
{% block footer %}{% endblock %}
