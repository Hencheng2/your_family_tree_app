{% extends 'base.html' %}

{% block title %}Settings{% endblock %}

{% block content %}
<style>
    /* Ensure body padding for fixed elements */
    body {
        /* Reset base.html padding-top/bottom as we'll manage content area directly */
        padding-top: 0;
        padding-bottom: 0;
        overflow: hidden; /* Prevent body scroll, scrolling will be in content-wrapper */
    }

    /* Fixed Top Container for Account Settings & Chat Background */
    .settings-header-section {
        position: fixed;
        top: 0; /* Managed by JS to sit below navbar */
        left: 0;
        width: 100%;
        background-color: var(--background-color);
        color: var(--text-color);
        padding: 15px 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Add a subtle shadow to fixed sections */
        border-bottom: 1px solid var(--card-border);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        box-sizing: border-box;
    }

    .settings-header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        max-width: 600px;
        margin-bottom: 15px;
    }

    .settings-header-container h2 {
        margin-bottom: 0;
        flex-grow: 1;
        text-align: center;
    }

    .settings-header-section h5 {
        margin-top: 20px;
        margin-bottom: 15px;
        font-size: 1.2em;
        text-align: center;
        width: 100%;
    }

    .settings-header-section .image-previews {
        display: flex;
        flex-direction: column; /* Stack images on mobile */
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        width: 100%;
    }

    .settings-header-section .image-previews .preview-item {
        text-align: center;
    }

    .settings-header-section .image-previews img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid var(--input-border);
    }

    .settings-header-section form {
        width: 100%;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 15px;
    }

    .settings-header-section .btn-group-vertical {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .settings-header-section .btn {
        width: 100%;
        padding: 10px 15px;
        border-radius: 8px;
    }

    /* Fixed Bottom Container for Account Actions */
    .settings-footer-section {
        position: fixed;
        bottom: 0; /* Managed by JS to sit above base footer */
        left: 0;
        width: 100%;
        background-color: var(--background-color);
        color: var(--text-color);
        padding: 15px 20px;
        box-shadow: 0 -2px 4px rgba(0,0,0,0.1); /* Subtle shadow on top edge */
        border-top: 1px solid var(--card-border);
        z-index: 999;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        box-sizing: border-box;
    }

    .settings-footer-section h5 {
        margin-bottom: 15px;
        font-size: 1.2em;
        text-align: center;
        width: 100%;
    }

    .settings-footer-section .btn-group {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        width: 100%;
        max-width: 400px;
    }

    /* New: Scrollable Content Wrapper */
    .settings-scrollable-content {
        position: absolute; /* Positioned relative to the body/viewport */
        left: 0;
        right: 0;
        overflow-y: auto; /* This makes it scrollable */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        box-sizing: border-box;
        padding: 20px; /* Padding for the content inside */
        /* Top and Bottom will be set by JS */
    }

    /* Adjust alert container position */
    .alert-container {
        /* Keep its current fixed positioning, it will overlay on top */
        top: 70px; /* Below navbar */
        z-index: 1050; /* Ensure it's above everything else */
    }

    /* Responsive adjustments */
    @media (min-width: 768px) {
        .settings-header-section {
            padding-top: 70px; /* Maintain space for main navbar */
            min-height: auto; /* Allow height to adjust to content */
        }
        .settings-header-section .image-previews {
            flex-direction: row; /* Align images side-by-side on desktop */
            justify-content: center;
        }
        .settings-header-section .btn-group-vertical {
            flex-direction: row; /* Buttons side-by-side */
            justify-content: center;
            flex-wrap: wrap;
        }
        .settings-header-section .btn {
            width: auto; /* Buttons can take natural width */
            flex-grow: 1; /* Allow them to grow if space permits */
        }

        .settings-footer-section {
            /* Keep fixed positioning, but ensure it's at the bottom of the viewport */
            position: fixed;
            bottom: 0; /* Will be adjusted by JS relative to base footer */
            left: 0;
            width: 100%;
            border-top: 1px solid var(--card-border);
        }
    }
</style>

{# Fixed Top Container: Account Settings & Chat Background #}
<div class="settings-header-section" id="settingsHeaderSection">
    <div class="settings-header-container">
        {# Dark Mode Switch - Far Left #}
        <div class="form-check form-switch me-auto"> {# ms-auto pushes it left #}
            <input class="form-check-input" type="checkbox" id="themeSwitch" {% if g.user_theme == 'dark' %}checked{% endif %}>
            <label class="form-check-label text-nowrap" for="themeSwitch">Dark Mode</label>
        </div>
        <h2 class="card-title text-center flex-grow-1">Account Settings</h2>
        <div></div> {# Empty div to balance flexbox, if needed, or remove if not #}
    </div>

    {# Flash messages are handled by base.html's alert-container, which is fixed #}
    {# No need for an extra alert-container here, it would duplicate #}
</div>

{# Scrollable Content Wrapper - This will hold the main settings forms #}
<div class="settings-scrollable-content" id="settingsScrollableContent">
    {# The content that was previously directly in fixed-settings-top-container's lower part #}
    {# and the fixed-settings-bottom-container's content will now go here #}

    <h5>Chat Background</h5>
    <div class="image-previews">
        <div class="preview-item">
            <p class="text-muted small mb-1">Current Chat Background:</p>
            {% if g.user_chat_background %}
                <img src="/{{ g.user_chat_background }}" alt="Current Chat Background">
            {% else %}
                <img src="{{ url_for('static', filename='img/default_chat_bg.jpg') }}" alt="Default Chat Background">
            {% endif %}
        </div>
        <div class="preview-item">
            <p class="text-muted small mb-1">Your Profile Photo:</p>
            {% if profile_photo_path %} {# Assuming profile_photo_path is passed from backend #}
                <img src="/{{ profile_photo_path }}" alt="Your Profile Photo">
            {% else %}
                <img src="{{ url_for('static', filename='img/default_profile.png') }}" alt="Default Profile Photo">
            {% endif %}
        </div>
    </div>

    <form action="{{ url_for('update_chat_background') }}" method="POST" enctype="multipart/form-data" class="mb-3">
        <div class="mb-3">
            <label for="background_file" class="form-label">Upload New Background Image</label>
            <input class="form-control" type="file" id="background_file" name="background_file" accept="image/*">
            <small class="form-text text-muted">Max file size 5MB. Supported: PNG, JPG, JPEG, GIF.</small>
        </div>
        <button type="submit" name="action" value="upload" class="btn btn-primary me-2">Upload & Set</button>
        <button type="submit" name="action" value="use_profile_photo" class="btn btn-info" {% if not profile_photo_path %}disabled{% endif %}>Use Profile Photo as Background</button>
    </form>

    <div class="btn-group-vertical mb-5"> {# Added mb-5 for space before bottom section if it scrolls #}
        <form action="{{ url_for('update_chat_background') }}" method="POST">
            <button type="submit" name="action" value="clear" class="btn btn-secondary">Clear Background</button>
        </form>
    </div>

    {# Account Actions - Now part of the scrollable content, but will be pushed down by fixed footer section #}
    {# It will appear at the bottom of the scrollable content, just above the fixed footer #}
    <h5 class="mt-5">Account Actions</h5> {# Added mt-5 for spacing from content above if it scrolls #}
    <div class="btn-group mb-5"> {# Added mb-5 for space at the very bottom of scrollable content #}
        {# Edit My Details button #}
        <a href="{{ url_for('edit_my_profile') }}" class="btn btn-warning">Edit My Details</a>
        {# Link to a dedicated change password page #}
        <a href="{{ url_for('change_password') }}" class="btn btn-info">Change Password</a>
        {# Logout Button #}
        <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
    </div>

</div>

{# Fixed Bottom Container: Account Actions (This will be the actual fixed footer section) #}
<div class="settings-footer-section" id="settingsFooterSection">
    {# This section will be dynamically positioned by JS right above the base.html footer #}
    {# No content needed here, as the content is now in settings-scrollable-content #}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-hide flash messages (already in base.html, but good to ensure it's here too if needed)
        const flashMessages = document.querySelectorAll('.flash');
        flashMessages.forEach(function(flash) {
            setTimeout(function() {
                flash.style.opacity = '0';
                flash.style.transition = 'opacity 0.5s ease-out';
                setTimeout(function() {
                    flash.remove();
                }, 500);
            }, 5000);
        });

        // Theme Switch Logic (Moved from base.html)
        const themeSwitch = document.getElementById('themeSwitch');
        if (themeSwitch) {
            const initialTheme = "{{ g.user_theme if g.user_theme else 'light' }}";
            document.body.className = initialTheme + '-theme';

            themeSwitch.checked = (initialTheme === 'dark');

            themeSwitch.addEventListener('change', function() {
                const theme = this.checked ? 'dark' : 'light';
                document.body.className = theme + '-theme';

                fetch('/update-theme-preference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ theme: theme })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Theme updated:', data.message);
                })
                .catch(error => {
                    console.error('Error updating theme:', error);
                });
            });
        }

        // --- Dynamic positioning for the scrollable content area ---
        const settingsHeaderSection = document.getElementById('settingsHeaderSection');
        const settingsFooterSection = document.getElementById('settingsFooterSection');
        const settingsScrollableContent = document.getElementById('settingsScrollableContent');
        const baseNavbarHeight = 70; // Assuming your base.html navbar is 70px tall
        const baseFooterHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--footer-height')) || 60;

        function adjustLayoutHeights() {
            if (settingsHeaderSection && settingsFooterSection && settingsScrollableContent) {
                // Position the header section right below the base navbar
                settingsHeaderSection.style.top = `${baseNavbarHeight}px`;

                // Calculate the height of the fixed header section
                const headerHeight = settingsHeaderSection.offsetHeight;

                // Position the footer section right above the base footer
                settingsFooterSection.style.bottom = `${baseFooterHeight}px`;

                // Calculate the height of the fixed footer section
                const footerHeight = settingsFooterSection.offsetHeight;

                // Set top and bottom for the scrollable content area
                settingsScrollableContent.style.top = `${baseNavbarHeight + headerHeight}px`;
                settingsScrollableContent.style.bottom = `${baseFooterHeight + footerHeight}px`;
            }
        }

        // Adjust on load and on window resize
        adjustLayoutHeights();
        window.addEventListener('resize', adjustLayoutHeights);

        // Also adjust after a small delay in case images or content load affects height
        window.addEventListener('load', adjustLayoutHeights);
        setTimeout(adjustLayoutHeights, 500); // Small delay to catch rendered heights
    });
</script>
{% endblock %}
{% block footer %}{% endblock %}
